// Auto-generated by create-backlist v5.1 (Prisma, From Endpoints)
import { Request, Response } from 'express';
import { prisma } from '../db/prisma';

<%
function safeAction(name, fallback) {
  if (!name) return fallback;
  return String(name).replace(/[^a-zA-Z0-9_]/g, '');
}

function hasIdInRoute(route) {
  return /:\w+/.test(route || '');
}

function hasBody(method) {
  const m = String(method || 'GET').toUpperCase();
  return ['POST', 'PUT', 'PATCH'].includes(m);
}

// prisma client accessor name. Usually lowerCamelCase in prisma client.
const prismaAccessor = controllerName.charAt(0).toLowerCase() + controllerName.slice(1);
%>

/**
 * Prisma model: <%= controllerName %>  (client: prisma.<%= prismaAccessor %>)
 * NOTE: If your prisma model name differs, adjust mapping in generator.
 */

<% (endpoints || []).forEach((ep, i) => { 
  const method = String(ep.method || 'GET').toUpperCase();
  const actionName = safeAction(ep.actionName, `handler${i}`);
  const route = (ep.route || ep.path || '').replace(/^\/api/, '');
  const usesId = hasIdInRoute(route);
-%>
/**
 * <%= method %> <%= ep.route || ep.path || '' %>
 */
export async function <%= actionName %>(req: Request, res: Response) {
  try {
<% if (method === 'POST') { -%>
    const created = await prisma.<%= prismaAccessor %>.create({ data: req.body });
    return res.status(201).json(created);
<% } else if (method === 'GET' && !usesId) { -%>
    const list = await prisma.<%= prismaAccessor %>.findMany();
    return res.status(200).json(list);
<% } else if (method === 'GET' && usesId) { -%>
    const idRaw = req.params.id;
    // Try number first; fallback to string
    const id: any = (idRaw !== undefined && idRaw !== null && String(Number(idRaw)) === idRaw) ? Number(idRaw) : idRaw;

    const found = await prisma.<%= prismaAccessor %>.findUnique({ where: { id } });
    if (!found) return res.status(404).json({ message: 'Not found' });
    return res.status(200).json(found);
<% } else if ((method === 'PUT' || method === 'PATCH') && usesId) { -%>
    const idRaw = req.params.id;
    const id: any = (idRaw !== undefined && idRaw !== null && String(Number(idRaw)) === idRaw) ? Number(idRaw) : idRaw;

    const updated = await prisma.<%= prismaAccessor %>.update({
      where: { id },
      data: req.body,
    });
    return res.status(200).json(updated);
<% } else if (method === 'DELETE' && usesId) { -%>
    const idRaw = req.params.id;
    const id: any = (idRaw !== undefined && idRaw !== null && String(Number(idRaw)) === idRaw) ? Number(idRaw) : idRaw;

    await prisma.<%= prismaAccessor %>.delete({ where: { id } });
    return res.status(200).json({ message: 'Deleted' });
<% } else { -%>
    // Non-CRUD or route not matching the default patterns
    // TODO: implement custom logic (query params, nested routes, etc.)
<% if (hasBody(method)) { -%>
    return res.status(200).json({ message: 'TODO: implement', body: req.body, params: req.params, query: req.query });
<% } else { -%>
    return res.status(200).json({ message: 'TODO: implement', params: req.params, query: req.query });
<% } -%>
<% } -%>
  } catch (error: any) {
    return res.status(500).json({ message: 'Internal Server Error', error: error?.message || error });
  }
}

<% }) -%>