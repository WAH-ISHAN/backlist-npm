// Auto-generated by create-backlist on <%= new Date().toISOString() %>
import { Router, Request, Response } from 'express';

<%
const controllers = [];
if (Array.isArray(endpoints)) {
  endpoints.forEach((ep) => {
    if (!ep) return;
    const c = ep.controllerName;
    if (!c || c === 'Default' || c === 'Auth') return;
    if (!controllers.includes(c)) controllers.push(c);
  });
}
%>

<% controllers.forEach((ctrl) => { %>
import * as <%= ctrl %>Controller from './controllers/<%= ctrl %>.controller';
<% }) %>

<% if (addAuth) { %>
import { protect } from './middleware/Auth.middleware';
<% } %>

const router = Router();

<% if (!Array.isArray(endpoints) || endpoints.length === 0) { %>
router.get('/health', (_req: Request, res: Response) => {
  res.status(200).json({ ok: true, message: 'Auto-generated routes alive' });
});
<% } %>

<%
if (Array.isArray(endpoints)) {
  endpoints.forEach((ep) => {
    if (!ep) return;

    const ctrl = ep.controllerName || 'Default';
    if (ctrl === 'Default' || ctrl === 'Auth') return;

    const raw = (ep.route || ep.path || '/');
    const expressPath = String(raw).replace(/^\/api/, '').replace(/{(\w+)}/g, ':$1') || '/';

    const method = String(ep.method || 'GET').toLowerCase();
    const fnName = ep.functionName; // preferred if generator computed it

    // fallback (if fnName not present)
    const hasId = expressPath.includes(':');
    let handler = '';
    if (fnName) {
      handler = `${ctrl}Controller.${fnName}`;
    } else {
      if (method === 'post' && !hasId) handler = `${ctrl}Controller.create${ctrl}`;
      else if (method === 'get' && !hasId) handler = `${ctrl}Controller.getAll${ctrl}s`;
      else if (method === 'get' && hasId) handler = `${ctrl}Controller.get${ctrl}ById`;
      else if ((method === 'put' || method === 'patch') && hasId) handler = `${ctrl}Controller.update${ctrl}ById`;
      else if (method === 'delete' && hasId) handler = `${ctrl}Controller.delete${ctrl}ById`;
    }

    const needsProtect = !!addAuth && (method === 'post' || method === 'put' || method === 'patch' || method === 'delete');
%>
router.<%= method %>(
  '<%- expressPath %>',
  <% if (needsProtect) { %>protect,<% } %>
  <% if (handler) { %><%- handler %><% } else { %>(req: Request, res: Response) => res.status(501).json({ message: "Not Implemented" })<% } %>
);
<% 
  });
}
%>

export default router;