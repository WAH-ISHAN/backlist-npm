// Auto-generated by create-backlist on <%= new Date().toISOString() %>
import { Router, Request, Response } from 'express';
<% 
// Build unique controller list safely
const controllers = [];
if (Array.isArray(endpoints)) {
  endpoints.forEach((ep) => {
    if (ep && ep.controllerName && ep.controllerName !== 'Default' && !controllers.includes(ep.controllerName)) {
      controllers.push(ep.controllerName);
    }
  });
}
%>
<% controllers.forEach((ctrl) => { %>
import * as <%= ctrl %>Controller from './controllers/<%= ctrl %>.controller';
<% }) %>

<% if (addAuth) { %>
import { protect } from './middleware/Auth.middleware';
<% } %>

const router = Router();

// If no endpoints detected, emit a basic route so file is valid
<% if (!Array.isArray(endpoints) || endpoints.length === 0) { %>
router.get('/health', (_req: Request, res: Response) => {
  res.status(200).json({ ok: true, message: 'Auto-generated routes alive' });
});
<% } %>

<% 
if (Array.isArray(endpoints)) {
  endpoints.forEach((ep) => { 
    const rawPath = (ep && ep.path) ? ep.path : '/';
    const expressPath = (rawPath.replace(/^\/api/, '') || '/').replace(/{(\w+)}/g, ':$1');
    const method = ((ep && ep.method) ? ep.method : 'GET').toLowerCase();
    const ctrl = (ep && ep.controllerName) ? ep.controllerName : 'Default';
    const hasId = expressPath.includes(':');
    let handler = '';

    if (ctrl !== 'Default') {
      if (method === 'post' && !hasId) handler = `${ctrl}Controller.create${ctrl}`;
      else if (method === 'get' && !hasId) handler = `${ctrl}Controller.getAll${ctrl}s`;
      else if (method === 'get' && hasId) handler = `${ctrl}Controller.get${ctrl}ById`;
      else if (method === 'put' && hasId) handler = `${ctrl}Controller.update${ctrl}ById`;
      else if (method === 'delete' && hasId) handler = `${ctrl}Controller.delete${ctrl}ById`;
    }

    const needsProtect = !!addAuth && (method === 'post' || method === 'put' || method === 'delete');
    const middleware = needsProtect ? 'protect, ' : '';
%>
router.<%= method %>('<%- expressPath || "/" %>', <%- middleware %><%- handler || '(req: Request, res: Response) => res.status(501).json({ message: "Not Implemented" })' %>);
<% 
  });
}
%>

export default router;