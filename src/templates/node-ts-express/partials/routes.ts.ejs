// Auto-generated by create-backlist on <%= new Date().toISOString() %>
import { Router, Request, Response } from 'express';

<%
/**
 * Collect controllers safely
 */
const controllers = [];
if (Array.isArray(endpoints)) {
  endpoints.forEach(ep => {
    if (ep && ep.controllerName && ep.controllerName !== 'Default' && !controllers.includes(ep.controllerName)) {
      controllers.push(ep.controllerName);
    }
  });
}
%>

<% controllers.forEach((ctrl) => { %>
import * as <%= ctrl %>Controller from './controllers/<%= ctrl %>.controller';
<% }) %>

<% if (addAuth) { -%>
import { protect } from './middleware/Auth.middleware';
<% } -%>

const router = Router();

<% if (!Array.isArray(endpoints) || endpoints.length === 0) { %>
router.get('/health', (_req: Request, res: Response) => {
  res.status(200).json({ ok: true, message: 'Auto-generated routes alive' });
});
<% } %>

<%
/**
 * Render endpoints
 * Prefer ep.route (normalized) and fallback to ep.path
 */
if (Array.isArray(endpoints)) {
  endpoints.forEach((ep) => {
    if (!ep) return;

    const raw = (ep.route || ep.path || '/');
    // mount router at /api in server.ts, so here we remove leading /api
    const expressPath = (String(raw).replace(/^\/api/, '') || '/')
      .replace(/{(\w+)}/g, ':$1'); // backward compat if analyzer still produces {id}

    const method = String(ep.method || 'GET').toLowerCase();
    const ctrl = ep.controllerName || 'Default';
    const action = ep.actionName || null;

    const needsProtect = !!addAuth && method !== 'get'; // default: protect non-GET
    const middleware = needsProtect ? 'protect, ' : '';

    let handler = '';
    if (ctrl !== 'Default' && action) {
      handler = `${ctrl}Controller.${action}`;
    }
%>
router.<%= method %>(
  '<%- expressPath %>',
  <%- middleware %><%- handler || '(req: Request, res: Response) => res.status(501).json({ message: "Not Implemented" })' %>
);
<%
  });
}
%>

export default router;