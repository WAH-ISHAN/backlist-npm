// Auto-generated by create-backlist v3.0 on <%= new Date().toISOString() %>
import { Router, Request, Response } from 'express';
<%# Create a unique set of controller names from the endpoints array %>
<% const controllersToImport = new Set(endpoints.map(ep => ep.controllerName).filter(name => name !== 'Default')); %>

// Import all the generated controllers
<% for (const controller of controllersToImport) { %>
import * as <%= controller %>Controller from '../controllers/<%= controller %>.controller';
<% } %>

<%# Import the protect middleware only if authentication is enabled %>
<% if (addAuth) { %>
import { protect } from '../middleware/Auth.middleware';
<% } %>

const router = Router();

<%# Loop through each endpoint found by the analyzer %>
<% endpoints.forEach(endpoint => { %>
<%
  // Convert URL path for Express router (e.g., /api/users/{id} -> /users/:id)
  const expressPath = endpoint.path.replace('/api', '').replace(/{(\w+)}/g, ':$1');
  const controllerName = endpoint.controllerName;
  let handlerFunction;

  // --- LOGIC TO MAP ENDPOINT TO A CRUD CONTROLLER FUNCTION ---
  if (controllerName !== 'Default') {
    if (endpoint.method === 'POST' && !expressPath.includes(':')) {
      handlerFunction = `${controllerName}Controller.create${controllerName}`;
    } else if (endpoint.method === 'GET' && !expressPath.includes(':')) {
      handlerFunction = `${controllerName}Controller.getAll${controllerName}s`;
    } else if (endpoint.method === 'GET' && expressPath.includes(':')) {
      handlerFunction = `${controllerName}Controller.get${controllerName}ById`;
    } else if (endpoint.method === 'PUT' && expressPath.includes(':')) {
      handlerFunction = `${controllerName}Controller.update${controllerName}ById`;
    } else if (endpoint.method === 'DELETE' && expressPath.includes(':')) {
      handlerFunction = `${controllerName}Controller.delete${controllerName}ById`;
    }
  }

  // If no specific CRUD function matches, create a placeholder handler.
  if (!handlerFunction) {
    handlerFunction = `(req: Request, res: Response) => {
      res.status(501).json({ message: 'Handler not implemented for <%= endpoint.method %> <%= expressPath %>' });
    }`;
  }

  // --- V3.0 AUTH LOGIC: Decide if the route should be protected ---
  // We protect all routes that modify data (POST, PUT, DELETE) if auth is enabled.
  // We leave GET routes public by default. This is a common pattern.
  const middleware = (addAuth && (endpoint.method === 'POST' || endpoint.method === 'PUT' || endpoint.method === 'DELETE')) 
    ? 'protect, ' 
    : '';
%>
/**
 * Route for <%= endpoint.method.toUpperCase() %> <%= endpoint.path %>
 * Mapped to: <%- handlerFunction.includes('=>') ? 'Inline Handler' : handlerFunction %>
 * Protected: <%= middleware ? 'Yes' : 'No' %>
 */
router.<%= endpoint.method.toLowerCase() %>('<%- expressPath %>', <%- middleware %><%- handlerFunction %>);

<% }); %>

export default router;