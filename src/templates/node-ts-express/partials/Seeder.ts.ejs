// Auto-generated by create-backlist on <%= new Date().toISOString() %>
import mongoose from 'mongoose';
import dotenv from 'dotenv';
import { faker } from '@faker-js/faker';
import chalk from 'chalk';

dotenv.config();

const MONGO_URI = process.env.MONGO_URI || 'mongodb://127.0.0.1:27017/<%= projectName %>';

function errMsg(e: unknown) {
  return e instanceof Error ? e.message : String(e);
}

// Dynamically import generated models
<%
  const models = Array.isArray(models) ? models : [];
  // Ensure unique by name
  const uniq = [];
  for (const m of models) {
    if (m && m.name && !uniq.find(x => x.name === m.name)) uniq.push(m);
  }
%>
<% uniq.forEach(m => { -%>
import <%= m.name %> from '../src/models/<%= m.name %>.model';
<% }); -%>

async function connectDB() {
  try {
    await mongoose.connect(MONGO_URI);
    console.log(chalk.green('MongoDB Connected for Seeder...'));
  } catch (e) {
    console.error(chalk.red(`Seeder DB Connection Error: ${errMsg(e)}`));
    process.exit(1);
  }
}

function fakeValue(fieldName: string, fieldType: string) {
  const n = fieldName.toLowerCase();

  if (fieldType === 'Number') {
    if (n.includes('price') || n.includes('amount') || n.includes('total')) return faker.number.int({ min: 10, max: 5000 });
    if (n.includes('age')) return faker.number.int({ min: 18, max: 70 });
    return faker.number.int({ min: 1, max: 999 });
  }

  if (fieldType === 'Boolean') return faker.datatype.boolean();

  // String
  if (n.includes('email')) return faker.internet.email().toLowerCase();
  if (n.includes('name')) return faker.person.fullName();
  if (n.includes('phone')) return faker.phone.number();
  if (n.includes('address')) return faker.location.streetAddress();
  if (n.includes('city')) return faker.location.city();
  if (n.includes('country')) return faker.location.country();
  if (n.includes('password')) return 'Password123!';
  if (n.includes('title')) return faker.lorem.words(3);
  if (n.includes('description')) return faker.lorem.paragraph();
  if (n.includes('image') || n.includes('avatar')) return faker.image.url();

  return faker.lorem.word();
}

async function importData() {
  try {
    console.log(chalk.blue('Clearing existing data...'));

    <% uniq.forEach(m => { -%>
    await <%= m.name %>.deleteMany();
    <% }); -%>

    console.log(chalk.blue('Inserting seed data...'));

    const count = 10;

    <% uniq.forEach(m => {
      const fields = Array.isArray(m.fields) ? m.fields : [];
    -%>
    // Seed <%= m.name %>
    {
      const rows: any[] = [];
      for (let i = 0; i < count; i++) {
        const obj: any = {};
        <% fields.forEach(f => { -%>
        obj['<%= f.name %>'] = fakeValue('<%= f.name %>', '<%= f.type %>');
        <% }); -%>
        rows.push(obj);
      }

      // Use create() to trigger hooks (e.g., password hashing)
      await <%= m.name %>.create(rows);
    }
    <% }); -%>

    console.log(chalk.green.bold('âœ… Data Imported Successfully!'));
  } catch (e) {
    console.error(chalk.red(`Error with data import: ${errMsg(e)}`));
    process.exitCode = 1;
  } finally {
    await mongoose.disconnect();
  }
}

async function destroyData() {
  try {
    <% uniq.forEach(m => { -%>
    await <%= m.name %>.deleteMany();
    <% }); -%>
    console.log(chalk.red.bold('ðŸ”¥ Data Destroyed Successfully!'));
  } catch (e) {
    console.error(chalk.red(`Error with data destruction: ${errMsg(e)}`));
    process.exitCode = 1;
  } finally {
    await mongoose.disconnect();
  }
}

async function runSeeder() {
  await connectDB();

  // `npm run destroy` passes "-d"
  if (process.argv[2] === '-d') await destroyData();
  else await importData();
}

runSeeder();