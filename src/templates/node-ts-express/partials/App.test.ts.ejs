// Auto-generated by create-backlist v5.1
import request from 'supertest';
import express from 'express';

import apiRoutes from '../routes';

<% if (addAuth) { -%>
import authRoutes from '../routes/Auth.routes';
<% } -%>

const app = express();
app.use(express.json());

// Mount auth first to avoid conflicts
<% if (addAuth) { -%>
app.use('/api/auth', authRoutes);
<% } -%>
app.use('/api', apiRoutes);

describe('API Endpoints (Generated)', () => {
  it('sanity check', () => {
    expect(1 + 1).toBe(2);
  });

  <% endpoints
    .filter(ep => ep && ep.route && ep.method)
    .forEach(ep => {
      const method = String(ep.method).toLowerCase();

      // make url relative to /api mount
      const url = (String(ep.route).startsWith('/api/')
        ? String(ep.route).replace(/^\/api/, '')
        : String(ep.route)
      )
      // replace path params ":id" with dummy
      .replace(/:\w+/g, '1');
  -%>
  it('<%= ep.method %> <%= url %> should respond', async () => {
    const req = request(app).<%= method %>('<%= '/api' + url %>');

    <% if (['post','put','patch'].includes(method) && ep.schemaFields) { -%>
    req.send(
      <%- JSON.stringify(
        Object.fromEntries(
          Object.entries(ep.schemaFields).map(([k, t]) => [
            k,
            t === 'Number' ? 1 : (t === 'Boolean' ? true : 'test')
          ])
        )
      ) %>
    );
    <% } -%>

    const res = await req;
    expect(res.statusCode).not.toBe(404);
  });
  <% }) -%>
});