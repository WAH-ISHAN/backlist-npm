// Auto-generated by create-backlist
package <%= group %>.<%= projectName %>.controller;

import <%= group %>.<%= projectName %>.model.User;
import <%= group %>.<%= projectName %>.repository.UserRepository;
import <%= group %>.<%= projectName %>.security.JwtService;

import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.Optional;

@RestController
@RequestMapping("/api/auth")
@CrossOrigin(origins = "*")
public class AuthController {

  private final UserRepository repo;
  private final PasswordEncoder encoder;
  private final JwtService jwt;

  public AuthController(UserRepository repo, PasswordEncoder encoder, JwtService jwt) {
    this.repo = repo;
    this.encoder = encoder;
    this.jwt = jwt;
  }

  @PostMapping("/register")
  public ResponseEntity<?> register(@RequestBody AuthRequest req) {
    if (repo.findByEmail(req.email()).isPresent()) {
      return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("User already exists");
    }

    User user = new User();
    user.setName(req.name());
    user.setEmail(req.email());
    user.setPassword(encoder.encode(req.password()));
    repo.save(user);

    String token = jwt.generateToken(user.getEmail());
    return ResponseEntity.status(HttpStatus.CREATED).body(new TokenResponse(token));
  }

  @PostMapping("/login")
  public ResponseEntity<?> login(@RequestBody LoginRequest req) {
    Optional<User> current = repo.findByEmail(req.email());
    if (current.isEmpty()) return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Invalid credentials");

    if (!encoder.matches(req.password(), current.get().getPassword())) {
      return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("Invalid credentials");
    }

    String token = jwt.generateToken(current.get().getEmail());
    return ResponseEntity.ok(new TokenResponse(token));
  }

  public record AuthRequest(String name, String email, String password) {}
  public record LoginRequest(String email, String password) {}
  public record TokenResponse(String token) {}
}